<!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    

    <title>Lua C API Simple Guide | Hualin</title>
    <meta name="author" content="Hualin">
    
    <meta name="description" content="Why we need Lua C API?The answer is simple, we want to use the libraries written in C/C++ etc. These libraries make our lives easy. Another reason is ">
    
    
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta property="og:title" content="Lua C API Simple Guide">
    <meta property="og:site_name" content="Hualin">

    
    <meta property="og:image" content="undefined">
    

    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="alternate" href="/atom.xml" title="Hualin" type="application/atom+xml">
    <link rel="stylesheet" href="/css/lib/materialize.min.css">
    <link rel="stylesheet" href="/css/lib/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">

    
        <link rel="stylesheet" href="/css/lib/prettify-tomorrow-night-eighties.css" type="text/css">
    
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
</head>
</html>

<body>
    <img src="/weixin_favicon.png" style="position: absolute; left: -9999px; opacity: 0; filter: alpha(opacity=0);">

    <nav class="indigo">
    <div class="nav-wrapper">
        <a href="#" data-activates="main-menu" class="button-collapse">
            <i class="fa fa-navicon"></i>
        </a>
        <div class>
            <a href="/" class="brand-logo hide-on-med-and-down">Hualin</a>
            <ul class="right hide-on-med-and-down">
                
                    <li>
                        <a class="menu-home " href="/">
                            <i class="fa fa-home "></i>
                            
                            Home
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-archive " href="/archives">
                            <i class="fa fa-archive "></i>
                            
                            Archives
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-category category-menu" href="javascript:;" data-activates="category-menu">
                            <i class="fa fa-bookmark "></i>
                            
                            Categories
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-about " href="/about">
                            <i class="fa fa-user "></i>
                            
                            About
                        </a>
                    </li>
                
                    <li>
                        <a class="menu-search modal-trigger " href="#search">
                            <i class="fa fa-search "></i>
                            
                            Search
                        </a>
                    </li>
                
            </ul>
            <div>
    <ul class="side-nav indigo darken-1" id="main-menu">
        
        <li class="side-user">
            <div class="row">
                <div class="col s4 no-padding">
                    <img class="avatar-image circle responsive-img" src="/imgs/header.jpg" alt="User Avatar">
                </div>
                <div class="info col s8 valign-wrapper no-padding">
                    <div class="valign">
                        <p class="name">Hualin</p>
                        <p class="desc">Developer</p>
                    </div>
                </div>
            </div>
        </li>
        

        
            <li class="no-padding">
                <a class="waves-effect menu-home " href="/">
                    <i class="fa fa-home "></i>
                    
                    Home
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-archive " href="/archives">
                    <i class="fa fa-archive "></i>
                    
                    Archives
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-category category-menu" href="javascript:;" data-activates="category-menu">
                    <i class="fa fa-bookmark "></i>
                    
                    Categories
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-about " href="/about">
                    <i class="fa fa-user "></i>
                    
                    About
                </a>
            </li>
        
            <li class="no-padding">
                <a class="waves-effect menu-search modal-trigger " href="#search">
                    <i class="fa fa-search "></i>
                    
                    Search
                </a>
            </li>
        
    </ul>

    <ul class="side-nav indigo darken-1" id="category-menu">
    

            

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Node-js/">
                    Node-js <span class="right">3</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Node-js/Redis/">
                    Redis <span class="right">1</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Node-js/Express/">
                    Express <span class="right">2</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Android/">
                    Android <span class="right">2</span></a>
                
            </li>

        

            <li class="collapse-level-1" collapse-level="1">
                <a class="no-padding" href="/categories/Android/UI/">
                    UI <span class="right">1</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Layabox-Engine/">
                    Layabox-Engine <span class="right">1</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Unity3D/">
                    Unity3D <span class="right">1</span></a>
                
            </li>

        

            <li class="collapse-level-0" collapse-level="0">
                <a class="no-padding" href="/categories/Hexo/">
                    Hexo <span class="right">1</span></a>
                
            </li>

        

    </ul>
</div>

        </div>
    </div>
</nav>

<div id="search" class="modal search-modal">
    <div class="row">
        <div class="input-field col s12">
              <input id="search-input" type="text">
              <label for="search-input">Search</label>
        </div>

    </div>
    <div id="search-result" class="search-result col s12">

    </div>
</div>


    <main>
        <div class="container main-container">
    <nav class="page-nav hide-on-small-only">
    <div class="nav-wrapper indigo">
        <span class="breadcrumb">Current page(Categories)</span>
        
            

        

        
    </div>
</nav>

<article>
    <div class="card">
        <div class="card-content">
            

            <div class="article-title">
                
    
        <h1>Lua C API Simple Guide</h1>
    


            </div>
            <time class="green-link-context" datetime="2022-01-15T12:17:23.000Z"><a href="/2022/01/15/lua-c-api/">2022-01-15</a></time>

            <span id="busuanzi_container_page_pv" class="read-times-container">
    <i class="fa fa-eye"></i>
    <span id="busuanzi_value_page_pv"></span>
</span>

            
    <div class="tags-row">
        
            <a href="/tags/lua/" class="chip indigo">lua</a>
        
            <a href="/tags/c/" class="chip indigo">c</a>
        
            <a href="/tags/api/" class="chip indigo">api</a>
        
            <a href="/tags/tutorial/" class="chip indigo">tutorial</a>
        
    </div>


            <div class="toc green-link-context hide-on-med-and-down">
    <ol class="section table-of-contents"><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#Why-we-need-Lua-C-API"><span class="section table-of-contents-text">Why we need Lua C API?</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#How-to-use-Lua-C-API"><span class="section table-of-contents-text">How to use Lua C API?</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#How-to-create-a-library"><span class="section table-of-contents-text">How to create a library</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#How-to-write-a-application-with-emmbeded-Lua"><span class="section table-of-contents-text">How to write a application with emmbeded Lua?</span></a></li><li class="section table-of-contents-item section table-of-contents-level-3"><a class="section table-of-contents-link" href="#Why-do-I-need-to-know-this"><span class="section table-of-contents-text">Why do I need to know this?</span></a></li></ol>
</div>


            <div class="entry green-link-context">
                <h3 id="Why-we-need-Lua-C-API"><a href="#Why-we-need-Lua-C-API" class="headerlink" title="Why we need Lua C API?"></a>Why we need Lua C API?</h3><p>The answer is simple, we want to use the libraries written in C/C++ etc. These libraries make our lives easy. Another reason is that we want to let the others extend our application easily.</p>
<h3 id="How-to-use-Lua-C-API"><a href="#How-to-use-Lua-C-API" class="headerlink" title="How to use Lua C API?"></a>How to use Lua C API?</h3><p>First, we must know the Lua Stack mechanism.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lua_pushnumber(L, number)</span><br><span class="line">lua_pushstring(L, <span class="string">"hello"</span>)</span><br><span class="line">lua_pushlightuserdata(L, &amp;f)</span><br></pre></td></tr></table></figure></p>
<p>The code above make the Stack like this<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    bottom</span><br><span class="line">- - - - - - -</span><br><span class="line"><span class="number">-3</span>  number  <span class="number">1</span></span><br><span class="line"><span class="number">-2</span>  <span class="string">"hello"</span> <span class="number">2</span></span><br><span class="line"><span class="number">-1</span> (void*)f <span class="number">3</span></span><br><span class="line">- - - - - - -</span><br><span class="line">     top</span><br></pre></td></tr></table></figure></p>
<p>And the Lua called C function <code>f(a, b, c)</code>, the Stack would be<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">       | <span class="number">-3</span> <span class="number">-2</span> <span class="number">-1</span> |</span><br><span class="line">bottom |  a  b  c | top</span><br><span class="line">       |  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span> |</span><br></pre></td></tr></table></figure></p>
<p>because the Lua push the parameters from left to right.</p>
<p>Second, we must know the Lua C API how to use the Stack, these informations are listed in <a href="https://www.lua.org/manual/5.4/manual.html" target="_blank" rel="noopener">Lua manual</a>.</p>
<p>Finally, we need know how to handle the errors with Lua C API. Again, these informations are listed in Lua manual.</p>
<h3 id="How-to-create-a-library"><a href="#How-to-create-a-library" class="headerlink" title="How to create a library"></a>How to create a library</h3><p>create C functions<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lua.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;lauxlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// lua code: hello("Billy")</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">say_hello</span><span class="params">(lua_State* L)</span></span>&#123;</span><br><span class="line">    <span class="comment">// get the parameter from the Stack</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name = luaL_checklstring(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">12</span>];</span><br><span class="line">    <span class="built_in">snprintf</span>(buf, <span class="number">12</span>, <span class="string">"Hello %s"</span>, name);</span><br><span class="line">    <span class="comment">// push the return value to the Stack</span></span><br><span class="line">    lua_pushstring(L, buf);</span><br><span class="line">    <span class="comment">// tell Lua the function has only one return value</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_hello</span><span class="params">(lua_State* L)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">fs</span>[] = &#123;</span></span><br><span class="line">        &#123;<span class="string">"hello"</span>, say_hello&#125;,</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    lua_newlib(L, fs);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We can now compile it with gcc<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -O2 -shared -fPIC `pkg-config lua --cflags --libs` -o hello.so</span><br></pre></td></tr></table></figure></p>
<p>and we can copy the hello.so to the Lua lib dir <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OR we can use luarocks to build and install the library, ```sudo luarocks make/build hello-1-0.rockspec```, but this is out of my article now.</span><br><span class="line"></span><br><span class="line">We can now use hello library in Lua:</span><br><span class="line">```lua</span><br><span class="line">local hello = require &apos;hello&apos;</span><br><span class="line">print(hello.hello(&quot;Jim&quot;))</span><br></pre></td></tr></table></figure></p>
<p>When we want to use third parties library written in C, we can do it like this, now we take libvips for an example.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vips/vips.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// lua code: open("/tmp/tmp1.png")</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vips_open</span><span class="params">(lua_State* L)</span></span>&#123;</span><br><span class="line">    VipsImage* img = vips_image_new_from_file(f, <span class="string">"access"</span>, VIPS_ACCESS_SEQUENTIAL, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!img)&#123;</span><br><span class="line">        vips_error_exit(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// because the img is struct VipsImage, this type is not supported in Lua, in other words, this is an user data, we use light user data because we did not create img with lua_newuserdata</span></span><br><span class="line">    lua_pushlightuserdata(L, img);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lua code: save(img, "/tmp/tmp2.png")</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">vips_save</span><span class="params">(lua_State* L)</span></span>&#123;</span><br><span class="line">    VipsImage* img = lua_touserdata(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* f = luaL_checkstring(L, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (vips_image_write_to_file(img, f, <span class="literal">NULL</span>))&#123;</span><br><span class="line">        vips_error_exit(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">luaopen_hello</span><span class="params">(lua_State* L)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_Reg</span> <span class="title">fs</span>[] = &#123;</span></span><br><span class="line">        &#123;<span class="string">"hello"</span>, say_hello&#125;,</span><br><span class="line">        &#123;<span class="string">"open"</span>, vips_open&#125;,</span><br><span class="line">        &#123;<span class="string">"save"</span>, vips_save&#125;</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    lua_newlib(L, fs);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (VIPS_INIT(<span class="string">"hello"</span>))&#123;</span><br><span class="line">        vips_error_exit(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>We compile it with gcc:<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -O2 -shared -fPIC `pkg-config lua --cflags --libs` `pkgconfig vips --cflags --libs` -o hello.so</span><br></pre></td></tr></table></figure></p>
<p>Because we use libvips library, we need specify the libvips’ header files and dynamic lib path</p>
<p>now we can use libvips in lua:<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> hello = <span class="built_in">require</span> <span class="string">'hello'</span></span><br><span class="line"><span class="built_in">print</span>(hello.hello(<span class="string">"vips"</span>))</span><br><span class="line"><span class="keyword">local</span> test_img = hello.<span class="built_in">open</span>(<span class="string">"./test.png"</span>)</span><br><span class="line">hello.save(test_img, <span class="string">"./test-copy.png"</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="How-to-write-a-application-with-emmbeded-Lua"><a href="#How-to-write-a-application-with-emmbeded-Lua" class="headerlink" title="How to write a application with emmbeded Lua?"></a>How to write a application with emmbeded Lua?</h3><p>That’s simple, read the <code>main</code> function in <code>lua.c</code>. Attention: call Lua C API in Lua protected mode as you can as possible, that is say, do your script in the function that started by lua_pcall, this way would prevent many strange crash, mem leaks etc, therefore, Lua recommend us use lua_newuserdata instead of light userdata, the Lua’s GC will collect the userdata carefully but skip light userdata at all.</p>
<h3 id="Why-do-I-need-to-know-this"><a href="#Why-do-I-need-to-know-this" class="headerlink" title="Why do I need to know this?"></a>Why do I need to know this?</h3><p>um…. because the libvips lua binding uses luajit which is legacy(it is rubbish nowadays, it do not support Lua5.3, Lua5.4, yes), and lua-cjson can’t compile with Lua5.4, and maybe other libs are outdated without maintainer etc. It’s a big pain, right? But now, I can write a simple binding for myself, right? We can heal ourself freely.</p>

                <p style="display: block;">

<span class="green-link-context" style="float:left; font-size: 12px;">
    <a href="/2022/01/15/logic/" rel="prev" title="Logic Fundamental">
    Prev: Logic Fundamental
  </a>
</span>



<span class="green-link-context" style="float: right; font-size: 12px;">
    <a href="/2021/01/04/business-talks-principle/" rel="next" title="Business Talks Principle">
    Next: Business Talks Principle
  </a>
</span>

</p>
            </div>
			
        </div>
    </div>
</article>






</div>

        <div class="fixed-action-btn float-sitemap">
    <a class="btn-floating btn-large pink">
      <i class="fa fa-caret-square-o-up"></i>
    </a>
    <ul>
      <li><a class="btn-return-top btn-floating waves-effect green" title="Return to top"><i class="fa fa-arrow-circle-o-up"></i></a></li>
      <li><a class="btn-floating waves-effect button-collapse yellow darken-1" data-activates="main-menu" title="Menu"><i class="fa fa-navicon"></i></a></li>
    </ul>
  </div>

    </main>
    <footer class="page-footer indigo darken-1">
    

    <div class="footer-copyright green-link-context">
        <div class="container">
            © 2017 hualin.me, All rights reserved.
            <p class="right" style="margin-top: 0;">Blog powered by <a href="https://hexo.io">Hexo</a> | Theme <a href="https://github.com/raytaylorlin/hexo-theme-raytaylorism">raytaylorism</a></p>
        </div>
    </div>
</footer>


    <noscript>
    <div class="noscript">
        <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
    </div>
</noscript>
<div class="noscript">
    <p class="center-align">当前网速较慢或者你使用的浏览器不支持博客特定功能，请尝试刷新或换用Chrome、Firefox等现代浏览器</p>
</div>


<script src="/js/jquery.min.js"></script>
<script src="/js/materialize.min.js"></script>

<script>
    (function($) {
        $(document).ready(function() {
            // 隐藏禁用javascript（针对微信内置浏览器）的提示
            $('.noscript').hide();

            // 图片缩放效果
            var $imgs = $('img').not('.slider-image').not('.avatar-image').not('.carousel-image').not('.card-cover-image').not('.qrcode');

            // 给图片加上点击放大效果（materialbox插件）
            $imgs.addClass('materialboxed').each(function(i, el) {
                $(this).attr('data-caption', $(this).attr('alt') || ' ');
            }).materialbox();

            // 优化表格的显示
            $('table').each(function() {
                var $table = $(this);
                // 除去多行代码的情况
                if ($table.find('pre').length == 0) {
                    $table.addClass('responsive-table striped bordered');
                }
            });

            // 首页幻灯片
            $('.slider').slider({indicators: true, full_width: true, interval: 8000});

            $(".button-collapse").sideNav();
            $(".category-menu").sideNav();

            // 针对gallery post
            $('.carousel').carousel({full_width: true});
            $('.carousel-control.prev').click(function() {
                $('.carousel').carousel('prev');
            });
            $('.carousel-control.next').click(function() {
                $('.carousel').carousel('next');
            });

            // 文章目录
            $('article').not('.simple-article').find('h1').add('h2').add('h3').add('h4').add('h5').add('h6').scrollSpy();

            // 目录随屏幕滚动（防止目录过长越过footer）
            var $toc = $('.toc');
            var scrollTargetTop = 0;
            $(window).scroll(function() {
                var $activeLink = $toc.find('a.active.section');
                if ($(window).scrollTop() < 100) {
                    scrollTargetTop = 0;
                } else {
                    if ($activeLink[0]) {
                        scrollTargetTop = $activeLink.offset().top - $toc.offset().top;
                    }
                }
                $toc.css('top', '-' + scrollTargetTop + 'px');
            });

            // 修正文章目录的left-border颜色
            var color = $('.table-of-contents-text').css('color');
            $('.table-of-contents-link').css('border-left-color', color);

            // 针对移动端做的优化：FAB按钮点击一下收回
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                $('.fixed-action-btn').addClass('click-to-toggle');
            }
            // 回到顶部
            $('.btn-return-top').click(function() {
                $('body, html').animate({
                    scrollTop: 0
                }, 500);
            });

            // 重置读书页面的Tab标签页的颜色
            $('li.tab a').hover(function() {
                $(this).toggleClass('text-lighten-4');
            });
            $('.indicator').addClass('pink lighten-2');

            
            // 添加new标签
            $('').append('<span class="new badge pink"></span>');
            

            // 搜索功能
            $('.modal-trigger').leanModal({
                // 打开搜索框时自动聚焦
                ready: function() {
                    if ($('#search').is(":visible")) {
                        $('#search-input').focus();
                    }
                }
            });
            var searchXml = "search.xml";
            if (searchXml.length == 0) {
             	searchXml = "search.xml";
            }
            var searchPath = "/" + searchXml;
            initSearch(searchPath, 'search-input', 'search-result');
        });

        // 初始化搜索与匹配函数
        var initSearch = function(path, search_id, content_id) {
            'use strict';
            $.ajax({
                url: path,
                dataType: "xml",
                success: function(xmlResponse) {
                    // get the contents from search data
                    var datas = $("entry", xmlResponse).map(function() {
                        return {
                            title: $("title", this).text(),
                            content: $("content", this).text(),
                            url: $("url", this).text()
                        };
                    }).get();
                    var $input = document.getElementById(search_id);
                    var $resultContent = document.getElementById(content_id);
                    $input.addEventListener('input', function() {
                        var str = '<ul class=\"search-result-list\">';
                        var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                        $resultContent.innerHTML = "";
                        if (this.value.trim().length <= 0) {
                            return;
                        }
                        // perform local searching
                        datas.forEach(function(data) {
                            var isMatch = true;
                            var content_index = [];
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty titles and contents
                            if (data_title != '' && data_content != '') {
                                keywords.forEach(function(keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);
                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            }
                            // show search results
                            if (isMatch) {
                                keywords.forEach(function(keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    data_title = data_title.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                });

                                str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 100 characters
                                    var start = first_occur - 20;
                                    var end = first_occur + 80;
                                    if (start < 0) {
                                        start = 0;
                                    }
                                    if (start == 0) {
                                        end = 100;
                                    }
                                    if (end > content.length) {
                                        end = content.length;
                                    }
                                    var match_content = content.substring(start, end);
                                    // highlight all keywords
                                    keywords.forEach(function(keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, "<span class=\"search-keyword green lighten-2\">" + keyword + "</span>");
                                    });

                                    str += "<p class=\"search-result\">..." + match_content + "...</p>"
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        $resultContent.innerHTML = str;
                    });
                }
            });
        }
    })(jQuery);
</script>


<script src="/js/prettify.js"></script>
<script type="text/javascript">
    $(document).ready(function() {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
</script>


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89101511-5', 'auto');
    ga('send', 'pageview');

</script>







</body>
</html>
